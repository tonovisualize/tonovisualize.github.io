<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TONO • Comparison</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="../styles.css/main.css" />

  <!-- Hydration + robust image-path resolver (tries multiple folder/prefix variants per type) -->
  <script>
    // Hydrate selection from window OR URL
    (function hydrateSelection(){
      if (!window.viewerSelection) {
        const p = new URLSearchParams(location.search);
        const type = p.get('type'), region = p.get('region'),
              tone = p.get('tone'), severity = p.get('severity');
        if (type && region && tone && severity) {
          window.viewerSelection = { type, region, tone, severity };
        }
      }
    })();

    // Type normalization + aliases
    const TYPE_ALIAS = {
      neurodermatitis:'neuro','neuro-dermatitis':'neuro',
      'contact-dermatitis':'contact','seborrheic-dermatitis':'seborrheic',
      'stasis-dermatitis':'stasis','nummular-dermatitis':'nummular',
      'dyshidrotic-eczema':'dyshidrotic'
    };
    function normalizeType(val){
      if(!val) return 'atopic';
      const k = String(val).toLowerCase().trim();
      return TYPE_ALIAS[k] || k;
    }

    // Folder/prefix variants for each type (so non-atopic paths work)
    const TYPE_VARIANTS = {
      atopic:      [['atopic','atopic'],['atopic-dermatitis','atopic-dermatitis']],
      contact:     [['contact','contact'],['contact-dermatitis','contact-dermatitis']],
      seborrheic:  [['seborrheic','seborrheic'],['seborrheic-dermatitis','seborrheic-dermatitis']],
      stasis:      [['stasis','stasis'],['stasis-dermatitis','stasis-dermatitis']],
      neuro:       [['neuro','neuro'],['neurodermatitis','neurodermatitis'],['neuro-dermatitis','neuro-dermatitis']],
      nummular:    [['nummular','nummular'],['nummular-dermatitis','nummular-dermatitis']],
      dyshidrotic: [['dyshidrotic','dyshidrotic'],['dyshidrotic-eczema','dyshidrotic-eczema']]
    };

    function buildCandidates({type, region, tone, severity}){
      const t = normalizeType(type);
      const variants = TYPE_VARIANTS[t] || TYPE_VARIANTS.atopic;
      const base = '../images/eczema/';
      return variants.map(([folder,prefix]) => `${base}${folder}/${prefix}-${region}-${tone}-${severity}.jpg`);
    }

    // Dev-friendly SVG placeholder
    function placeholder(type, region, tone, severity){
      const label = `${type} • ${region} • ${tone} • ${severity}`;
      const svg = encodeURIComponent(
        `<svg xmlns='http://www.w3.org/2000/svg' width='1200' height='900'>
          <defs><linearGradient id='g' x1='0' x2='1'><stop stop-color='#c7d2fe'/><stop offset='1' stop-color='#e9d5ff'/></linearGradient></defs>
          <rect width='100%' height='100%' fill='url(#g)'/>
          <circle cx='600' cy='450' r='260' fill='rgba(255,255,255,.45)'/>
          <text x='50%' y='50%' text-anchor='middle' fill='#1f2473' font-size='44' font-family='Inter' dy='10'>${label}</text>
        </svg>`
      );
      return `data:image/svg+xml;utf8,${svg}`;
    }

    // Try candidates sequentially; fallback to placeholder if all fail
    function loadWithFallback(imgEl, candidates, alt, phArgs){
      let i = 0;
      imgEl.alt = alt;
      imgEl.onerror = () => {
        i++;
        if (i < candidates.length) imgEl.src = candidates[i];
        else { imgEl.onerror = null; imgEl.src = placeholder(...phArgs); }
      };
      imgEl.src = candidates[0];
    }

    // Expose to bottom script
    window._tono = { buildCandidates, loadWithFallback, placeholder, normalizeType };
  </script>

  <style>
    :root{
      --ink:#1f2473; --bg:#f2f4fb; --card:#fff; --muted:#6b7280; --ring:#7a86ff;
      --shadow:0 8px 24px rgba(31,36,115,.12); --radius:18px;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial; background:var(--bg); color:#0f172a}
    .wrap{max-width:1100px; margin:32px auto; padding:16px}
    h1{font-size:24px; color:var(--ink); margin:8px 0 16px}
    .lede{max-width:560px; line-height:1.6; color:#334155; margin-bottom:20px}
    .current{font-weight:600; color:var(--ink); margin:8px 0 16px}
    .panel{background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px; border:1px solid #e5e7eb}

    .mode-toggle{display:flex; gap:8px; margin:8px 0 16px}
    .seg{border:1px solid #d1d5db; background:#f8fafc; color:#1f2937; padding:8px 12px; border-radius:999px; cursor:pointer; font-weight:600}
    .seg[aria-pressed="true"]{background:var(--ink); color:#fff; border-color:var(--ink); box-shadow:0 0 0 3px rgba(122,134,255,.25)}

    .canvas{position:relative; width:100%; aspect-ratio:1.3/1; background:#eef2ff; border-radius:var(--radius); overflow:hidden; border:1px solid #e5e7eb}
    .side-by-side{display:grid; grid-template-columns:1fr 1fr; gap:0}
    .slot{position:relative; overflow:hidden}
    .slot img{width:100%; height:100%; object-fit:cover; display:block}

    .overlay{position:relative}
    .overlay img{position:absolute; inset:0; width:100%; height:100%; object-fit:cover}
    .imgB{clip-path:inset(0 0 0 var(--cut,50%))}
    .divider{position:absolute; top:0; bottom:0; width:4px; background:var(--ink); left:var(--cut,50%); transform:translateX(-2px); box-shadow:0 0 0 3px rgba(31,36,115,.15)}
    .handle{position:absolute; left:var(--cut,50%); top:50%; transform:translate(-50%,-50%); width:36px; height:36px; border-radius:18px; background:var(--ink); display:grid; place-items:center; color:#fff; font-weight:900; cursor:ew-resize; box-shadow:0 6px 18px rgba(31,36,115,.25), 0 0 0 3px rgba(122,134,255,.25); border:2px solid #fff}
    .handle:focus-visible{outline:none; box-shadow:0 0 0 4px rgba(122,134,255,.5)}

    .edit{position:absolute; bottom:12px; left:12px; z-index:5; display:flex; align-items:center; gap:8px; background:#ffffffea; color:#1f2473; border:1px solid #e5e7eb; padding:6px 10px; border-radius:12px; font-weight:700; cursor:pointer; box-shadow:var(--shadow)}
    .edit.right{left:auto; right:12px}
    .edit[aria-pressed="true"]{background:var(--ink); color:#fff; border-color:var(--ink); box-shadow:0 0 0 3px rgba(122,134,255,.25), var(--shadow)}

    .card{background:var(--card); border:1px solid #e5e7eb; border-radius:var(--radius); padding:12px}
    .card h3{margin:0 0 8px; color:var(--ink); font-size:14px}
    .row{display:flex; flex-wrap:wrap; gap:8px}

    .pill{border:1px solid #c7cbe1; padding:8px 12px; border-radius:999px; cursor:pointer; font-weight:600; background:#f8f9ff}
    .pill[aria-pressed="true"]{background:var(--ink); color:#fff; border-color:var(--ink); box-shadow:0 0 0 3px rgba(122,134,255,.25)}

    .sw{width:52px; height:36px; border-radius:10px; border:2px solid #e5e7eb; cursor:pointer; position:relative}
    .sw[aria-pressed="true"]{outline:3px solid var(--ring)}
    .sw[data-tone="light"]{background:#f5e3d3}
    .sw[data-tone="medium"]{background:#d5a98b}
    .sw[data-tone="olive"]{background:#b5835a}
    .sw[data-tone="dark"]{background:#6a4a3a}
    .sw span{position:absolute; inset:auto 6px 4px auto; font-size:10px; color:#0f172a66}

    .grid{display:grid; grid-template-columns:1.1fr .9fr; gap:20px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .muted{color:var(--muted); font-size:14px}
    .badge{display:inline-block; padding:.25rem .5rem; border-radius:999px; background:#eef2ff; color:#1f2473; font-weight:700}
  </style>
</head>
<body>
  <!-- Header -->
  <header class="white-header">
    <div class="logo"><a href="../index.html"><img src="../images/logo.png" alt="Tono Logo"></a></div>
    <div class="menu-icon" id="menuIcon" aria-label="Open menu" role="button" tabindex="0"><span></span><span></span><span></span></div>
  </header>

  <!-- Full Screen Menu -->
  <div id="fullScreenMenu" class="full-screen-menu" hidden>
    <nav>
      <a href="../index.html">Home</a>
      <a href="../pages/viewer.html">Eczema Visualizer</a>
      <a href="../pages/learnmod2.html">Learn About Eczema</a>
      <a href="../pages/resources.html">Resources</a>
      <a href="../pages/about.html">About Us</a>
      <a href="../pages/gallery2.html">Image Gallery</a>
    </nav>
  </div>

  <!-- Breadcrumb -->
  <section class="breadcrumb" style="padding:10px 16px">
    <p style="margin:0; color:#475569">
      <a href="../pages/viewer.html" style="color:#1f2473; font-weight:700; text-decoration:none">Eczema Visualizer</a>
      <span style="opacity:.45"> › </span>
      <span>Comparison Tool</span>
    </p>
  </section>

  <div class="wrap">
    <h1>Comparison Tool</h1>
    <p class="lede">Compare the same condition across different skin tones or severities. Switch between <strong>Side-by-Side</strong> and an <strong>Overlay</strong> with a draggable slider.</p>
    <div id="current" class="current"></div>

    <div class="grid">
      <!-- LEFT: Canvas -->
      <div class="panel">
        <div class="mode-toggle" role="group" aria-label="Comparison mode">
          <button class="seg" id="btnSide" aria-pressed="true">Side-by-Side</button>
          <button class="seg" id="btnOverlay" aria-pressed="false">Overlay (slider)</button>
        </div>

        <!-- Side-by-side -->
        <div id="canvasSide" class="canvas side-by-side" aria-label="Side by side comparison" role="region">
          <div class="slot">
            <img id="imgA_side" alt="Image A" />
            <button class="edit" id="editA" aria-pressed="false" aria-label="Edit Image A">Edit A</button>
          </div>
          <div class="slot">
            <img id="imgB_side" alt="Image B" />
            <button class="edit right" id="editB" aria-pressed="true" aria-label="Edit Image B">Edit B</button>
          </div>
        </div>

        <!-- Overlay -->
        <div id="canvasOverlay" class="canvas overlay" aria-label="Overlay comparison with slider" role="region" hidden>
          <img id="imgA_overlay" class="imgA" alt="Image A" />
          <img id="imgB_overlay" class="imgB" alt="Image B" />
          <div class="divider" aria-hidden="true"></div>
          <button id="sliderHandle" class="handle" aria-label="Drag to reveal" aria-valuemin="0" aria-valuemax="100" aria-valuenow="50">↔</button>
          <button class="edit" id="editA2" aria-pressed="false" aria-label="Edit Image A">Edit A</button>
          <button class="edit right" id="editB2" aria-pressed="true" aria-label="Edit Image B">Edit B</button>
        </div>

        <p class="muted" style="margin-top:10px">Tip: in Overlay mode, drag the handle or use ←/→ keys when focused.</p>
      </div>

      <!-- RIGHT: Selectors -->
      <div class="panel">
        <div class="card">
          <h3>Currently viewing</h3>
          <div id="chips"></div>
        </div>

        <!-- Type (shared A & B). Region is auto-set per type (no UI). -->
        <div class="card">
          <h3>Condition Type</h3>
          <div class="row" id="typeRow"></div>
          <p class="muted" style="margin-top:8px">Type is shared for A &amp; B. Region auto-updates to that condition’s default.</p>
        </div>

        <div class="card">
          <h3>Edit <span id="editBadge" class="badge">Image B</span></h3>
          <div class="row" id="toneRow"></div>
          <div class="row" id="sevRow" style="margin-top:10px"></div>
        </div>

        <div class="card">
          <h3>Swap Images</h3>
          <div class="row">
            <button id="swap" class="pill" aria-pressed="false">Swap A ↔ B</button>
            <button id="resetB" class="pill" aria-pressed="false">Reset B</button>
          </div>
        </div>
      </div>
    </div>

    <section class="panel" style="margin-top:20px">
      <h2>Disclaimer</h2>
      <p class="muted">This tool is for educational purposes. It supports—not replaces—clinical judgment. For medical concerns, consult a qualified healthcare provider.</p>
    </section>
  </div>

  <!--div class="back-to-top"><a href="#">Back to top ▲</a></div-->

  <footer style="margin:40px auto; text-align:center; font-size:14px; color:#6b7280">
    <p>© 2025 TONO — Naomi Clay - University of Toronto MScBMC program</p>
  </footer>

  <!-- Self-contained logic -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const { buildCandidates, loadWithFallback, placeholder, normalizeType } = window._tono;

      /* ---------- 1) Choices ---------- */
      const TONES  = ['light','medium','olive','dark'];
      const SEVERITIES = ['normal','mild','moderate','severe'];
      const TYPES = [
        { key:'atopic', label:'Atopic Dermatitis' },
        { key:'contact', label:'Contact Dermatitis' },
        { key:'seborrheic', label:'Seborrheic Dermatitis' },
        { key:'stasis', label:'Stasis Dermatitis' },
        { key:'neuro', label:'Neurodermatitis' },
        { key:'nummular', label:'Nummular Dermatitis' },
        { key:'dyshidrotic', label:'Dyshidrotic Eczema' }
      ];

      // Region policy: which regions exist per condition + default
      const TYPE_REGIONS = {
        atopic:      { list:['face-neck','hands-feet'],   def:'face-neck' },
        contact:     { list:['face','hand'],              def:'face' },
        seborrheic:  { list:['face', 'scalp'],            def:'face' },
        stasis:      { list:['ankles', 'shins'],          def:'ankles' },
        neuro:       { list:['neck','wrist'],             def:'neck' },
        nummular:    { list:['legs','arms'],              def:'legs' },
        dyshidrotic: { list:['palms','soles'],            def:'palms' }
      };
      function coerceRegionForType(type, currentRegion){
        const t = normalizeType(type);
        const cfg = TYPE_REGIONS[t] || TYPE_REGIONS.atopic;
        return cfg.list.includes(currentRegion) ? currentRegion : cfg.def;
      }

      /* ---------- 2) State ---------- */
      const initial = (window.viewerSelection) || { type:'atopic', region:'face-neck', tone:'dark', severity:'mild' };
      try { initial.type = normalizeType(initial.type); } catch(e){}
      initial.region = coerceRegionForType(initial.type, initial.region);

      let A = {...initial};
      let B = {...initial, tone:'light'};
      let mode = 'side';
      let cut = 50;
      let editTarget = 'B';

      /* ---------- 3) DOM ---------- */
      const el = {
        current: document.getElementById('current'),
        imgA_side: document.getElementById('imgA_side'),
        imgB_side: document.getElementById('imgB_side'),
        imgA_overlay: document.getElementById('imgA_overlay'),
        imgB_overlay: document.getElementById('imgB_overlay'),
        canvasOverlay: document.getElementById('canvasOverlay'),
        canvasSide: document.getElementById('canvasSide'),
        handle: document.getElementById('sliderHandle'),
        toneRow: document.getElementById('toneRow'),
        sevRow: document.getElementById('sevRow'),
        chips: document.getElementById('chips'),
        btnSide: document.getElementById('btnSide'),
        btnOverlay: document.getElementById('btnOverlay'),
        swap: document.getElementById('swap'),
        resetB: document.getElementById('resetB'),
        editA: document.getElementById('editA'),
        editB: document.getElementById('editB'),
        editA2: document.getElementById('editA2'),
        editB2: document.getElementById('editB2'),
        editBadge: document.getElementById('editBadge'),
        typeRow: document.getElementById('typeRow')
      };

      /* ---------- 4) Renderers ---------- */
      function titleCase(s){ return s.replace(/(^|[-_])/g,' ').replace(/\b\w/g,c=>c.toUpperCase()).trim() }

      function renderHeader(){
        const typeName = {
          atopic:'Atopic Dermatitis', contact:'Contact Dermatitis', seborrheic:'Seborrheic Dermatitis',
          stasis:'Stasis Dermatitis', neuro:'Neurodermatitis', nummular:'Nummular Dermatitis', dyshidrotic:'Dyshidrotic Eczema'
        }[A.type] || titleCase(A.type);
        el.current.innerHTML =
          `Currently viewing: <span style="font-weight:800">${typeName}</span> • <span class="badge">${titleCase(A.region)}</span>`;
      }

      function renderImages(){
        const candA = buildCandidates(A);
        const candB = buildCandidates(B);
        const altA = `${A.type}, ${A.region}, ${A.tone} tone, ${A.severity} severity`;
        const altB = `${B.type}, ${B.region}, ${B.tone} tone, ${B.severity} severity`;

        loadWithFallback(el.imgA_side, candA, altA, [A.type,A.region,A.tone,A.severity]);
        loadWithFallback(el.imgB_side, candB, altB, [B.type,B.region,B.tone,B.severity]);

        loadWithFallback(el.imgA_overlay, candA, altA, [A.type,A.region,A.tone,A.severity]);
        loadWithFallback(el.imgB_overlay, candB, altB, [B.type,B.region,B.tone,B.severity]);
      }

      function renderChips(){
        el.chips.innerHTML = `
          <div class="row">
            <span class="pill">A • ${titleCase(A.tone)} • ${titleCase(A.severity)}</span>
            <span class="pill">B • ${titleCase(B.tone)} • ${titleCase(B.severity)}</span>
          </div>`;
      }

      function renderTypePicker(){
        el.typeRow.innerHTML = '';
        TYPES.forEach(t=>{
          const btn = document.createElement('button');
          btn.className = 'pill';
          btn.textContent = t.label;
          btn.setAttribute('aria-pressed', t.key === A.type ? 'true' : 'false');
          btn.title = `Switch to ${t.label}`;
          btn.addEventListener('click', ()=>{
            const newType = normalizeType(t.key);
            // Auto-update region to that type’s default/valid option
            const newRegion = coerceRegionForType(newType, A.region);
            A.type = newType; B.type = newType;
            A.region = newRegion; B.region = newRegion;
            renderAll();
          });
          el.typeRow.appendChild(btn);
        });
      }

      function renderSelectors(){
        const T = (editTarget === 'A') ? A : B;

        el.toneRow.innerHTML = '';
        TONES.forEach(t=>{
          const b = document.createElement('button');
          b.className = 'sw'; b.dataset.tone = t;
          b.setAttribute('aria-pressed', t === T.tone ? 'true' : 'false');
          b.innerHTML = `<span>${t}</span>`;
          b.addEventListener('click', ()=>{
            if (editTarget === 'A') A.tone = t; else B.tone = t;
            renderAll();
          });
          el.toneRow.appendChild(b);
        });

        el.sevRow.innerHTML = '';
        SEVERITIES.forEach(s=>{
          const btn = document.createElement('button');
          btn.className = 'pill'; btn.textContent = titleCase(s);
          btn.setAttribute('aria-pressed', s === T.severity ? 'true' : 'false');
          btn.addEventListener('click', ()=>{
            if (editTarget === 'A') A.severity = s; else B.severity = s;
            renderAll();
          });
          el.sevRow.appendChild(btn);
        });
      }

      function setMode(m){
        mode = m;
        const isSide = m==='side';
        el.canvasSide.hidden = !isSide;
        el.canvasOverlay.hidden = isSide;
        el.btnSide.setAttribute('aria-pressed', String(isSide));
        el.btnOverlay.setAttribute('aria-pressed', String(!isSide));
      }

      function setCut(pct){
        cut = Math.min(100, Math.max(0, pct));
        const v = cut + '%';
        el.canvasOverlay.style.setProperty('--cut', v);
        el.handle.style.setProperty('--cut', v);
        el.handle.setAttribute('aria-valuenow', String(Math.round(cut)));
      }

      function renderEditUI(){
        el.editBadge.textContent = `Image ${editTarget}`;
        const isA = editTarget === 'A';
        el.editA.setAttribute('aria-pressed', String(isA));
        el.editA2.setAttribute('aria-pressed', String(isA));
        el.editB.setAttribute('aria-pressed', String(!isA));
        el.editB2.setAttribute('aria-pressed', String(!isA));
      }

      function renderAll(){
        renderHeader();
        renderImages();
        renderChips();
        renderTypePicker();
        renderSelectors();
        renderEditUI();
        setCut(cut);
      }

      /* ---------- 5) Events ---------- */
      el.btnSide.addEventListener('click', ()=> setMode('side'));
      el.btnOverlay.addEventListener('click', ()=> setMode('overlay'));

      el.swap.addEventListener('click', ()=>{ const temp = {...A}; A = {...B}; B = temp; renderAll(); });
      el.resetB.addEventListener('click', ()=>{
        // Keep the current shared type/region; reset B tone to light
        B = {...A, tone:'light'};
        renderAll();
      });

      [el.editA, el.editA2].forEach(b=> b.addEventListener('click', ()=>{ editTarget='A'; renderAll(); }));
      [el.editB, el.editB2].forEach(b=> b.addEventListener('click', ()=>{ editTarget='B'; renderAll(); }));

      // Overlay drag
      let dragging = false;
      function pxToPct(x, box){ return Math.min(100, Math.max(0, ((x - box.left) / box.width) * 100)); }
      el.canvasOverlay.addEventListener('pointerdown', (e)=>{
        dragging = true; el.canvasOverlay.setPointerCapture(e.pointerId);
        const box = el.canvasOverlay.getBoundingClientRect(); setCut(pxToPct(e.clientX, box));
      });
      window.addEventListener('pointermove', (e)=>{ if(!dragging) return; const box = el.canvasOverlay.getBoundingClientRect(); setCut(pxToPct(e.clientX, box)); });
      window.addEventListener('pointerup', ()=> dragging=false);

      el.handle.tabIndex = 0;
      el.handle.addEventListener('keydown', (e)=>{
        if(e.key==='ArrowLeft'){ setCut(cut-2); e.preventDefault(); }
        if(e.key==='ArrowRight'){ setCut(cut+2); e.preventDefault(); }
      });

      /* ---------- 6) Boot ---------- */
      renderAll();
      setMode('side');
      setCut(50);
    });
  </script>

  <script src="../script.js/menu.js" defer></script>
</body>
</html>
